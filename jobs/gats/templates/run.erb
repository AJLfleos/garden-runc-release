#!/usr/bin/env bash
set -ex

base=$PWD

cd "$(dirname "$0")/.."

cd packages/gats/bin

export GARDEN_ADDRESS="<%= p("garden_address") %>"
export GARDEN_PORT="<%= p("garden_port") %>"
export CONTAINERD_FOR_PROCESSES_ENABLED="<%= p("containerd_for_processes") %>"
export ROOTLESS="<%= p("rootless") %>"
export CPU_THROTTLING_ENABLED="<%= p("cpu_throttling") %>"
export WINDOWS_TEST_ROOTFS="<%= p("windows_rootfs") %>"

cmd="./ginkgo -mod vendor --nodes=${GINKGO_NODES:-8} --failOnPending --randomizeSuites --randomizeAllSpecs garden-integration-tests.test"

if [ -n "${WINDOWS_TEST_ROOTFS:-}" ]; then
  export GARDEN_ADDRESS="<%= link('garden-windows').instances[0].address %>"
  export GARDEN_PORT="<%= link('garden-windows').p('garden.listen_address').split(":")[1] %>"
  cmd="./ginkgo -mod vendor -stream gats98.test"
fi

$cmd
