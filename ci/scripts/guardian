#!/bin/bash
# vim: set ft=sh
set -ex

cd $(dirname $0)/../..

export GOROOT=/usr/local/go
export PATH=$GOROOT/bin:$PATH

export GOPATH=$PWD
export PATH=$GOPATH/bin:$PATH

pushd src/github.com/opencontainers/runc
  go build -tags "seccomp apparmor" --ldflags '-extldflags "-static"' -o runc .
  mv runc /usr/local/bin/runc
popd

# Note: this obviously isn't great, but is just a temporary measure that will
# be addressed in the next story
# https://www.pivotaltracker.com/story/show/140407919
rm -rf src/github.com/opencontainers/runc
pushd src/github.com/opencontainers
  git clone https://github.com/cyphar/runc
  cd runc
  git checkout rootless-containers

  git config --global user.email "you@example.com"
  git config --global user.name "Your Name"
  git cherry-pick f47980f6b14865906387174e72d060ce2d780a3c
  git cherry-pick 2d416e5e1dd4b96e13c391d2be76d787dc9e2a30

  make
  mv runc /usr/local/bin/runc-rootless
popd


# Set up runC
mkdir -p /var/run/oci
mount -t tmpfs tmpfs /var/run/oci

# Set up AppArmor
mount -t securityfs securityfs /sys/kernel/security
if ! aa-status | grep garden-default > /dev/null; then
  apparmor_parser -a ci/assets/garden-default
fi

cd src/code.cloudfoundry.org/guardian

export GARDEN_TEST_ROOTFS=/opt/warden/rootfs
export GARDEN_PREEXISTING_USERS_TEST_ROOTFS=/opt/warden/preexisting-users-rootfs
export GARDEN_FUSE_TEST_ROOTFS=/opt/warden/fuse-rootfs
export GARDEN_NESTABLE_TEST_ROOTFS=/opt/warden/nestable-rootfs
export GARDEN_TAR_PATH=/opt/tar
export GARDEN_TEST_GRAPHPATH=/tmp/aufs_mount
export GARDEN_DORA_PATH=$PWD/../garden-integration-tests/resources/dora.tgz
export ROOTLESS_RUNC_PATH=/usr/local/bin/runc-rootless
[ -d /opt/warden/docker-registry-v2-rootfs ] && export GARDEN_DOCKER_REGISTRY_V2_TEST_ROOTFS=/opt/warden/docker-registry-v2-rootfs

go vet ./...
ginkgo -tags daemon -r -p -race -cover -keepGoing -nodes=8 -failOnPending -randomizeSuites "$@"
